<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”¼ì ë‹®ìŒë¹„ì™€ ë¶€í”¼ë¹„ íƒêµ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        #scene-container {
            background-color: #1a202c;
            border-radius: 0.5rem;
            cursor: grab;
        }
        #scene-container:active {
            cursor: grabbing;
        }
        .btn {
            @apply bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition-all duration-200 w-full disabled:bg-gray-500 disabled:cursor-not-allowed;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700;
        }
        input[type="number"], input[type="text"], textarea {
            @apply w-full px-4 py-2 text-xl text-center border-2 border-gray-600 rounded-lg font-bold focus:outline-none focus:border-teal-400;
            background-color: #FFFFFF;
            color: #000000;
        }
        textarea {
            @apply text-base;
        }
        .highlight {
            @apply text-teal-300 font-bold;
        }
        .formula-box {
            @apply bg-gray-700 p-4 rounded-lg my-3;
        }
        /* Custom animation for revealing content */
        .reveal {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-300">ğŸ• í”¼ì, ì–¼ë§ˆë‚˜ ë§ì´ ë‹´ì„ ìˆ˜ ìˆì„ê¹Œ?</h1>
            <p class="text-lg text-gray-400 mt-2">ë‹®ìŒë¹„ì™€ ë¶€í”¼ë¹„ì˜ ë¹„ë°€ì„ íŒŒí—¤ì³ ë´ìš”!</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- 3D Visualization -->
            <div class="flex-grow">
                <div id="scene-container" class="w-full h-96 lg:h-[500px]"></div>
                <p class="text-center text-xs text-gray-500 mt-2">ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸í•´ íšŒì „í•˜ê³ , ìŠ¤í¬ë¡¤ë¡œ í™•ëŒ€/ì¶•ì†Œí•´ ë³´ì„¸ìš”.</p>
            </div>

            <!-- Interactive Panel -->
            <div class="w-full lg:w-96 bg-gray-800 p-6 rounded-lg shadow-xl flex-shrink-0 flex flex-col justify-center">
                
                <!-- STEP 0: ë‹®ìŒë¹„ ì§ˆë¬¸ -->
                <div id="step-0" class="space-y-4">
                    <p class="text-xl text-teal-300 font-bold text-center">ì§ˆë¬¸ 1.</p>
                    <p class="text-lg text-center">ë‘ í”¼ìê°€ ë‹®ì€ ì›ê¸°ë‘¥ ëª¨ì–‘ì¼ ë•Œ,<br> <span class="highlight">ë‹®ìŒë¹„</span>ëŠ” ì–´ë–»ê²Œ ë ê¹Œìš”?</p>
                    <div class="bg-gray-700 p-4 rounded-lg space-y-3">
                        <div>
                            <div class="text-pink-300 font-bold">S ì‚¬ì´ì¦ˆ í”¼ì</div>
                            <div class="text-gray-300 text-sm">ì§€ë¦„ 20cm, ë†’ì´ 2cm</div>
                        </div>
                        <div class="mt-3">
                            <div class="text-yellow-300 font-bold">L ì‚¬ì´ì¦ˆ í”¼ì</div>
                            <div class="text-gray-300 text-sm">ì§€ë¦„ 30cm, ë†’ì´ ?cm</div>
                        </div>
                    </div>
                    <div id="ratio-input-container">
                        <input type="text" id="ratio-input" placeholder="ì •ë‹µì„ 'A:B' í˜•ì‹ìœ¼ë¡œ ì…ë ¥">
                    </div>
                    <div id="answer-feedback-0" class="hidden text-center p-3 rounded-lg"></div>
                    <button id="check-ratio-btn" class="btn">ì •ë‹µ ì œì¶œ</button>
                    <button id="next-btn-0" class="btn hidden">ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ</button>
                </div>

                <!-- STEP 1: ì–‘ ì¶”ì¸¡í•˜ê¸° -->
                <div id="step-1" class="hidden space-y-4">
                    <p class="text-xl text-teal-300 font-bold text-center">ì§ˆë¬¸ 2.</p>
                    <p class="text-lg text-center">Lí”¼ì í•œ íŒì€<br>Sí”¼ì <span class="highlight">ëª‡ íŒ</span>ì˜ ì–‘ê³¼ ê°™ì„ê¹Œìš”?</p>
                    <p class="text-sm text-gray-400 text-center">ëŒ€ëµì ìœ¼ë¡œ ì¶”ì¸¡í•´ì„œ ìˆ«ìë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</p>
                    <div class="flex items-center justify-center gap-3 my-4">
                        <input type="number" id="guessInput" class="w-40 text-2xl" min="1" max="10" step="0.1" placeholder="ì˜ˆ: 2.5">
                    </div>
                    <button id="next-btn-1" class="btn">ì¶”ì¸¡í•œ ì–‘ìœ¼ë¡œ ì‹¤í—˜í•˜ê¸°</button>
                </div>

                <!-- STEP 2: ì‹¤í—˜ ê²°ê³¼ ë° ë‹¤ìŒ ì§ˆë¬¸ -->
                <div id="step-2" class="hidden space-y-4">
                    <p class="text-xl text-teal-300 font-bold text-center">ğŸ§ª ì‹¤í—˜ ê²°ê³¼</p>
                    <div id="status" class="text-center p-4 bg-gray-700 rounded-lg text-gray-300">
                        <!-- Status message will be inserted here by JS -->
                    </div>
                     <p class="text-lg text-center mt-4">3ê³¼ 4 ì‚¬ì´ì˜ ê°’ì¸ ê²ƒ ê°™ì€ë°...<br>ì´ ìˆ«ìë¥¼ <span class="highlight">ì •í™•íˆ</span> êµ¬í•  ìˆ˜ ìˆì„ê¹Œìš”?</p>
                    <div class="formula-box text-center">
                        <p class="text-sm text-gray-400">í”¼ìì˜ 'ì–‘'ì€ ë¬´ì—‡ê³¼ ê´€ë ¨ ìˆì„ê¹Œìš”?</p>
                         <p class="text-lg mt-1">(íŒíŠ¸: ë„í˜•ì˜ <span class="highlight">ë¶€í”¼</span>)</p>
                    </div>
                    <div class="flex justify-between gap-2">
                        <button id="prev-btn-2" class="btn btn-secondary">ë‹¤ì‹œ ì¶”ì¸¡</button>
                        <button id="next-btn-2" class="btn" disabled>ì •í™•í•œ Sí”¼ì ê°œìˆ˜ êµ¬í•˜ë ¤ë©´?</button>
                    </div>
                </div>

                <!-- STEP 3: ë¶€í”¼ë¹„ ê³„ì‚° -->
                <div id="step-3" class="hidden space-y-4">
                    <p class="text-xl text-teal-300 font-bold text-center">ğŸ’¡ ì›ë¦¬ ë°œê²¬: ë¶€í”¼ë¹„</p>
                    <div class="text-gray-200 space-y-2 text-sm">
                        <div class="formula-box">
                            <p>ë‹®ìŒë¹„ê°€ <span class="highlight text-lg">2 : 3</span> ì´ë¯€ë¡œ,</p>
                        </div>
                        <div class="formula-box bg-teal-900 reveal">
                            <p class="mb-2">ë¶€í”¼ë¹„ëŠ” ê° ìˆ«ìë¥¼ <span class="highlight">ì„¸ì œê³±</span>í•œ ê°’ê³¼ ê°™ì•„ìš”.</p>
                            <p class="text-xl highlight mt-1 text-center">2Â³ : 3Â³</p>
                            <p class="text-2xl highlight mt-1 text-center">= 8 : 27</p>
                        </div>
                        <p class="text-center text-gray-400 reveal" style="animation-delay: 0.5s;">ì¦‰, Sí”¼ì <span class="highlight">27íŒ</span>ì˜ ì–‘ì€ Lí”¼ì <span class="highlight">8íŒ</span>ì˜ ì–‘ê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
                    </div>
                    <!-- New interactive part -->
                    <div id="final-question-container" class="mt-4 space-y-3 reveal" style="animation-delay: 1s;">
                        <p class="text-center text-gray-200">ê·¸ëŸ¼ Lí”¼ì 1íŒì€ Sí”¼ì ëª‡ íŒê³¼ ê°™ì„ê¹Œìš”?</p>
                        <input type="text" id="final-answer-input" placeholder="ë‹µ (ì†Œìˆ˜ ë˜ëŠ” ë¶„ìˆ˜)">
                        <textarea id="reasoning-input" rows="2" placeholder="ì´ìœ  (ë¶€í”¼ë¹„ê°€.. ë‹ˆê¹Œ..)"></textarea>
                        <div id="answer-feedback-3" class="hidden text-center p-2 rounded-lg text-sm"></div>
                        <button id="check-final-answer-btn" class="btn btn-secondary">ë‹µ í™•ì¸í•˜ê¸°</button>
                    </div>
                    <div class="flex justify-between gap-2 mt-4">
                        <button id="prev-btn-3" class="btn btn-secondary">ì´ì „</button>
                        <button id="next-btn-3" class="btn hidden">ì •í™•í•œ ê°’ ê³„ì‚°í•˜ê¸°</button>
                    </div>
                </div>

                <!-- STEP 4: ìµœì¢… í™•ì¸ -->
                <div id="step-4" class="hidden space-y-4">
                    <p class="text-xl text-teal-300 font-bold text-center">ğŸ¯ ìµœì¢… í™•ì¸</p>
                    <div class="formula-box text-center">
                        <p class="text-sm">Sí”¼ì 27íŒ = Lí”¼ì 8íŒ</p>
                        <p class="text-lg mt-2">Lí”¼ì 1íŒ = Sí”¼ì <span class="highlight">27 / 8</span> íŒ</p>
                        <p class="text-3xl highlight mt-2">3.375</p>
                    </div>
                     <p class="text-center text-sm text-gray-300">
                        ì •í™•í•œ ê°’ <span class="highlight">3.375</span>ë¡œ ë‹¤ì‹œ ì‹¤í—˜í•´ì„œ<br>Lí”¼ìê°€ ê°€ë“ ì±„ì›Œì§€ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”!
                    </p>
                    <button id="final-check-btn" class="btn">ì •í™•í•œ ê°’ìœ¼ë¡œ í™•ì¸</button>
                    <button id="restart-btn" class="btn btn-secondary mt-2">ì²˜ìŒë¶€í„°</button>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <script>
        const L_RADIUS = 1.5, L_HEIGHT = 0.3, S_RADIUS = 1.0, S_HEIGHT = 0.2;
        const L_VOLUME = Math.PI * L_RADIUS * L_RADIUS * L_HEIGHT;
        const S_VOLUME = Math.PI * S_RADIUS * S_RADIUS * S_HEIGHT;
        const EXACT_COUNT = L_VOLUME / S_VOLUME; // 3.375

        let scene, camera, renderer, controls, sPizza, lPizzaContainer, pizzaTexture, filledPizza = null;
        const flyingPieces = [];
        let currentStep = 0;
        const steps = [0,1,2,3,4].map(i => document.getElementById(`step-${i}`));
        const sceneContainer = document.getElementById('scene-container');
        
        let userGuess = 0;
        let trialCount = 0;
        let hasUnderflowed = false;
        let hasOverflowed = false;

        function setStep(i) {
            currentStep = i;
            steps.forEach((s, idx) => s.classList.toggle('hidden', idx !== i));
            
            if (i === 1) {
                document.getElementById('guessInput').focus();
            }
            if (i === 2) {
                checkButtonActivation();
            }
             if (i === 3) {
                document.getElementById('next-btn-3').classList.add('hidden');
                document.getElementById('check-final-answer-btn').classList.remove('hidden');
                document.getElementById('answer-feedback-3').classList.add('hidden');
                document.getElementById('final-answer-input').value = '';
                document.getElementById('reasoning-input').value = '';
            }
        }

        function checkButtonActivation() {
            const nextBtn = document.getElementById('next-btn-2');
            nextBtn.textContent = 'ì •í™•í•œ Sí”¼ì ê°œìˆ˜ êµ¬í•˜ë ¤ë©´?';
            const conditionMet = trialCount >= 5 || 
                                 (hasUnderflowed && hasOverflowed) || 
                                 (userGuess > 0 && Math.abs(userGuess - EXACT_COUNT) <= 0.1);

            if (conditionMet) {
                nextBtn.disabled = false;
                nextBtn.classList.add('animate-pulse');
            } else {
                nextBtn.disabled = true;
                nextBtn.classList.remove('animate-pulse');
            }
        }

        // 3D Scene Initialization
        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a202c);
            camera = new THREE.PerspectiveCamera(75, sceneContainer.clientWidth / sceneContainer.clientHeight, 0.1, 1000);
            camera.position.set(0, 4.5, 5);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(sceneContainer.clientWidth, sceneContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            sceneContainer.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const light = new THREE.DirectionalLight(0xffffff, 0.9);
            light.position.set(5, 10, 7.5);
            light.castShadow = true;
            scene.add(light);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 3;
            controls.maxDistance = 12;

            pizzaTexture = createPizzaTexture();
            sPizza = createPizza(S_RADIUS, S_HEIGHT);
            sPizza.position.set(-3.5, S_HEIGHT / 2, 0);
            scene.add(sPizza);

            lPizzaContainer = createContainer(L_RADIUS, L_HEIGHT);
            lPizzaContainer.position.set(2, 0, 0);
            scene.add(lPizzaContainer);
            
            window.addEventListener('resize', onResize);
            animate();
        }

        function createPizzaTexture() {
            const c = document.createElement('canvas');
            c.width = c.height = 256;
            const ctx = c.getContext('2d');
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(0, 0, 256, 256);
            ctx.fillStyle = '#C04040';
            for (let i = 0; i < 20; i++) {
                ctx.beginPath();
                ctx.arc(Math.random()*256, Math.random()*256, 10+Math.random()*10, 0, Math.PI*2);
                ctx.fill();
            }
            return new THREE.CanvasTexture(c);
        }

        function createPizza(r, h) {
            const g = new THREE.Group();
            const crust = new THREE.MeshStandardMaterial({ color: '#D2B48C' });
            const top = new THREE.MeshStandardMaterial({ map: pizzaTexture });
            const geo = new THREE.CylinderGeometry(r, r, h, 64);
            const mesh = new THREE.Mesh(geo, [crust, top, crust]);
            mesh.castShadow = true;
            g.add(mesh);
            return g;
        }

        function createPiece() {
            const crust = new THREE.MeshStandardMaterial({ color: '#D2B48C' });
            const top = new THREE.MeshStandardMaterial({ map: pizzaTexture });
            const r = S_RADIUS * 0.25;
            const h = S_HEIGHT * 0.5;
            const geo = new THREE.CylinderGeometry(r, r, h, 32);
            return new THREE.Mesh(geo, [crust, top, crust]);
        }
        
        function createContainer(r, h) {
            const g = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color: '#999', side: THREE.DoubleSide, transparent: true, opacity: 0.15 });
            const bottom = new THREE.Mesh(new THREE.CylinderGeometry(r, r, 0.02, 64), mat);
            bottom.position.y = -h/2;
            const wall = new THREE.Mesh(new THREE.CylinderGeometry(r, r, h, 64, 1, true), mat);
            g.add(bottom, wall);
            return g;
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            
            for (let i = flyingPieces.length - 1; i >= 0; i--) {
                const p = flyingPieces[i];
                p.progress += 0.03;
                const arc = Math.sin(p.progress * Math.PI) * 2.5;
                p.mesh.position.lerpVectors(p.start, p.end, p.progress);
                p.mesh.position.y += arc;
                p.mesh.rotation.x += 0.1;
                p.mesh.rotation.y += 0.15;
                
                if (p.progress >= 1) {
                    scene.remove(p.mesh);
                    flyingPieces.splice(i, 1);
                }
            }
            renderer.render(scene, camera);
        }

        function onResize() {
            camera.aspect = sceneContainer.clientWidth / sceneContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(sceneContainer.clientWidth, sceneContainer.clientHeight);
        }

        function runExperiment(count) {
            if (count <= 0) {
                updateFilled(0);
                updateStatus(0);
                return;
            }

            // Clear previous pieces and animations
            flyingPieces.forEach(p => scene.remove(p.mesh));
            flyingPieces.length = 0;
            updateFilled(0);

            const numPieces = Math.max(8, Math.ceil(count * 8));
            for (let i = 0; i < numPieces; i++) {
                const pieceMesh = createPiece();
                const startPos = new THREE.Vector3(
                    sPizza.position.x + (Math.random() - 0.5) * S_RADIUS,
                    sPizza.position.y,
                    sPizza.position.z + (Math.random() - 0.5) * S_RADIUS
                );
                pieceMesh.position.copy(startPos);
                scene.add(pieceMesh);
                
                const fillRatio = Math.min(1, count / EXACT_COUNT);
                const endPos = new THREE.Vector3(
                    lPizzaContainer.position.x + (Math.random() - 0.5) * L_RADIUS * 1.8,
                    lPizzaContainer.position.y - L_HEIGHT/2 + (Math.random() * L_HEIGHT * fillRatio),
                    lPizzaContainer.position.z + (Math.random() - 0.5) * L_RADIUS * 1.8
                );
                
                flyingPieces.push({ mesh: pieceMesh, start: startPos, end: endPos, progress: Math.random() * -0.2 });
            }

            // Update the filled volume after a delay
            setTimeout(() => {
                updateFilled(count);
                updateStatus(count);
            }, 1200);
        }

        function updateFilled(count) {
            if (filledPizza) lPizzaContainer.remove(filledPizza);
            if (count <= 0) return;
            
            const fillRatio = Math.min(1.2, count / EXACT_COUNT); // Allow for overflow visualization
            const fillHeight = L_HEIGHT * fillRatio;
            
            const crust = new THREE.MeshStandardMaterial({ color: '#D2B48C' });
            const top = new THREE.MeshStandardMaterial({ map: pizzaTexture });
            const geo = new THREE.CylinderGeometry(L_RADIUS*0.98, L_RADIUS*0.98, fillHeight, 64);
            filledPizza = new THREE.Mesh(geo, [crust, top, crust]);
            
            filledPizza.position.y = -L_HEIGHT/2 + fillHeight/2;
            lPizzaContainer.add(filledPizza);
        }
        
        function updateStatus(cnt) {
            const pct = (cnt / EXACT_COUNT) * 100;
            const el = document.getElementById('status');
            let statusText = `(ì‹œë„: ${trialCount}íšŒ) ë‹¹ì‹ ì˜ ì¶”ì¸¡: ${cnt.toFixed(2)}ê°œ<br>`;

            if (cnt === 0) {
                statusText = 'ê°’ì„ ì…ë ¥í•´ ì±„ì›Œë³´ì„¸ìš”!';
            } else if (Math.abs(cnt - EXACT_COUNT) < 0.01) {
                el.className = 'text-center p-4 bg-teal-900 rounded-lg text-teal-200 font-bold';
                statusText += `ğŸ‰ ì •í™•í•´ìš”! Lí”¼ìê°€ ì™„ë²½í•˜ê²Œ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!`;
            } else if (pct < 98) {
                el.className = 'text-center p-4 bg-yellow-900 rounded-lg text-yellow-200';
                statusText += `ğŸ• ì¡°ê¸ˆ ë¶€ì¡±í•´ìš”! ì•„ì§ ê³µê°„ì´ ë‚¨ì•˜ì–´ìš”!`;
            } else if (pct <= 102) {
                el.className = 'text-center p-4 bg-green-900 rounded-lg text-green-200';
                statusText += `ğŸ‘ ê±°ì˜ ë§ì•˜ì–´ìš”! ì•„ì£¼ ì¡°ê¸ˆ ì°¨ì´ê°€ ë‚˜ë„¤ìš”!`;
            } else {
                el.className = 'text-center p-4 bg-red-900 rounded-lg text-red-200';
                statusText += `ğŸ’¥ ë„ˆë¬´ ë§ì•„ìš”! í”¼ìê°€ ë„˜ì³ íë¦…ë‹ˆë‹¤!`;
            }
            el.innerHTML = statusText;
        }
        
        // Event Listeners
        document.getElementById('check-ratio-btn').addEventListener('click', () => {
            const ratioInput = document.getElementById('ratio-input');
            const answer = ratioInput.value.replace(/\s/g, ''); // remove all spaces
            const feedbackEl = document.getElementById('answer-feedback-0');
            
            if (answer === '2:3') {
                feedbackEl.innerHTML = `<p class="text-green-300 font-bold">ì •ë‹µì…ë‹ˆë‹¤ ğŸ˜Š</p>`;
                feedbackEl.className = 'text-center p-3 rounded-lg bg-teal-900';
                
                document.getElementById('ratio-input-container').classList.add('hidden');
                document.getElementById('check-ratio-btn').classList.add('hidden');
                document.getElementById('next-btn-0').classList.remove('hidden');
            } else {
                feedbackEl.innerHTML = `<p class="text-red-300 font-bold">ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”!</p>`;
                feedbackEl.className = 'text-center p-3 rounded-lg bg-red-900';
                ratioInput.focus();
            }
            feedbackEl.classList.remove('hidden');
        });

        document.getElementById('next-btn-0').addEventListener('click', () => setStep(1));
        
        document.getElementById('next-btn-1').addEventListener('click', () => {
            userGuess = parseFloat(document.getElementById('guessInput').value) || 0;
            if (userGuess <= 0) {
                alert("1 ì´ìƒì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            trialCount++;
            if (userGuess < EXACT_COUNT) {
                hasUnderflowed = true;
            } else if (userGuess > EXACT_COUNT) {
                hasOverflowed = true;
            }

            setStep(2);
            runExperiment(userGuess);
        });

        document.getElementById('prev-btn-2').addEventListener('click', () => {
            updateFilled(0);
            setStep(1)
        });
        document.getElementById('next-btn-2').addEventListener('click', () => setStep(3));

        document.getElementById('prev-btn-3').addEventListener('click', () => setStep(2));
        
        document.getElementById('check-final-answer-btn').addEventListener('click', () => {
            const answerInput = document.getElementById('final-answer-input').value.trim();
            const feedbackEl = document.getElementById('answer-feedback-3');
            
            if (answerInput === '3.375' || answerInput === '27/8') {
                feedbackEl.innerHTML = 'ì •ë‹µì…ë‹ˆë‹¤! ì›ë¦¬ë¥¼ ì •í™•íˆ ì´í•´í–ˆë„¤ìš”. ğŸ‘';
                feedbackEl.className = 'text-center p-2 rounded-lg text-sm bg-teal-900';
                document.getElementById('next-btn-3').classList.remove('hidden');
                document.getElementById('check-final-answer-btn').classList.add('hidden');
            } else {
                feedbackEl.innerHTML = 'ì•„ì‰½ë„¤ìš”. ë¶€í”¼ë¹„(8:27)ë¥¼ ë‹¤ì‹œ í•œë²ˆ ìƒê°í•´ë³´ì„¸ìš”.';
                feedbackEl.className = 'text-center p-2 rounded-lg text-sm bg-red-900';
            }
            feedbackEl.classList.remove('hidden');
        });

        document.getElementById('next-btn-3').addEventListener('click', () => setStep(4));
        
        document.getElementById('final-check-btn').addEventListener('click', () => {
            runExperiment(EXACT_COUNT);
            // Also update status immediately for the perfect case
            setTimeout(() => {
                const el = document.getElementById('status');
                el.className = 'text-center p-4 bg-teal-900 rounded-lg text-teal-200 font-bold';
                el.innerHTML = `ğŸ‰ ì •í™•í•´ìš”! Lí”¼ìê°€ ì™„ë²½í•˜ê²Œ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!`;
            }, 1200);
        });

        document.getElementById('restart-btn').addEventListener('click', () => {
            userGuess = 0;
            trialCount = 0;
            hasUnderflowed = false;
            hasOverflowed = false;
            document.getElementById('guessInput').value = '';
            updateFilled(0);
            // Reset step 0
            document.getElementById('ratio-input-container').classList.remove('hidden');
            document.getElementById('ratio-input').value = '';
            document.getElementById('answer-feedback-0').classList.add('hidden');
            document.getElementById('check-ratio-btn').classList.remove('hidden');
            document.getElementById('next-btn-0').classList.add('hidden');
            setStep(0);
        });
        
        init3D();
        setStep(0);
    </script>
</body>
</html>

